# 短链接系统后端设计文档

## 目录

1. [系统概述](#系统概述)
2. [系统架构](#系统架构)
3. [模块设计](#模块设计)
4. [数据库设计](#数据库设计)
5. [核心功能设计](#核心功能设计)
6. [技术栈](#技术栈)
7. [部署架构](#部署架构)

---

## 1. 系统概述

### 1.1 项目简介

短链接系统是一个基于 Spring Cloud 微服务架构的短链接管理平台，支持短链接生成、管理、统计和回收站功能。系统采用前后端分离架构，后端使用微服务设计，支持高并发访问和水平扩展。

### 1.2 核心功能

- **短链接生成**: 支持随机生成短链接，使用哈希算法生成唯一后缀
- **短链接跳转**: 高性能短链接跳转服务，支持缓存优化
- **数据统计**: 实时访问统计、地域分析、设备分析、浏览器分析等
- **分组管理**: 支持短链接分组管理，便于分类组织
- **回收站**: 删除的短链接可恢复，支持软删除机制
- **用户管理**: 用户注册、登录、权限管理、密码找回
- **访问日志**: 详细记录每次访问的详细信息

---

## 2. 系统架构

### 2.1 整体架构

系统采用微服务架构，主要包含三个核心服务模块：

```
┌─────────────────────────────────────────────────────────┐
│                     前端应用层                            │
│              React + TypeScript + Ant Design            │
└────────────────────┬────────────────────────────────────┘
                     │ HTTP/HTTPS
┌────────────────────┴────────────────────────────────────┐
│                   网关服务层                            │
│          Spring Cloud Gateway (端口: 8000)              │
│  - 路由转发                                              │
│  - Token验证                                             │
│  - CORS跨域配置                                          │
└────────────┬─────────────────────┬─────────────────────┘
             │                     │
    ┌────────┴────────┐   ┌────────┴────────┐
    │   管理服务模块    │   │   核心业务模块    │
    │  Admin Service   │   │ Project Service  │
    │   (端口: 8002)   │   │   (端口: 8001)   │
    └──────────────────┘   └──────────────────┘
```

### 2.2 服务模块划分

#### 2.2.1 Gateway 服务（网关模块）

**职责**:
- 统一入口，所有前端请求通过网关路由到对应服务
- Token 验证和用户身份识别
- 请求路由和负载均衡
- CORS 跨域配置

**技术栈**:
- Spring Cloud Gateway
- Redis（Token存储）
- Nacos Discovery（服务发现）

#### 2.2.2 Admin 服务（管理服务）

**职责**:
- 用户管理：注册、登录、个人信息管理、密码修改
- 分组管理：创建、修改、删除、排序分组
- 短链接管理：创建、修改、删除、查询短链接（管理端接口）
- 回收站管理：恢复删除的短链接、彻底删除
- 邮件服务：发送验证码、找回密码
- 文件上传：用户头像上传（MinIO）

**技术栈**:
- Spring Boot 3.0.7
- MyBatis Plus
- ShardingSphere（分库分表）
- Redisson（分布式锁）
- Nacos Discovery
- OpenFeign（服务间调用）
- MinIO（对象存储）
- Spring Mail（邮件服务）

#### 2.2.3 Project 服务（核心业务服务）

**职责**:
- 短链接生成：使用哈希算法生成唯一短链接
- 短链接跳转：高性能跳转服务，支持缓存优化
- 数据统计：访问统计、地域统计、设备统计等
- 访问日志记录：详细记录每次访问信息
- 统计数据处理：通过 Kafka 异步处理统计数据

**技术栈**:
- Spring Boot 3.0.7
- MyBatis Plus
- ShardingSphere（分库分表）
- Redisson（布隆过滤器、分布式锁）
- Kafka（消息队列）
- Sentinel（限流降级）
- Nacos Discovery

### 2.3 中间件层

- **Nacos**: 服务注册与配置中心（端口: 8848）
- **Redis**: 缓存服务（端口: 6379）
  - Token 存储
  - 短链接信息缓存
  - 布隆过滤器（防止缓存穿透）
  - 分布式锁
- **Kafka**: 消息队列（端口: 9092）
  - 统计数据异步处理
- **MinIO**: 对象存储（端口: 9000/9001）
  - 用户头像存储
- **MySQL**: 数据库（端口: 3306）
  - 分库分表存储

---

## 3. 模块设计

### 3.1 Gateway 模块设计

#### 3.1.1 核心组件

**路由配置** (`application-dev.yaml`):
- `/api/short-link/admin/**` → `short-link-admin` 服务
- `/api/short-link/**` → `short-link-project` 服务

**过滤器**:
- `TokenValidateGatewayFilterFactory`: Token 验证过滤器
  - 从请求头获取 `username` 和 `token`
  - 从 Redis 验证 Token 有效性
  - 将用户信息（userId, realName）注入请求头传递给下游服务
  - 支持白名单路径配置

**跨域配置**:
- `CorsConfig`: CORS 跨域配置
  - 允许所有来源
  - 支持携带凭证
  - 预检请求缓存 3600 秒

#### 3.1.2 关键代码位置

```
gateway/
├── src/main/java/com/xduo/shortlink/gateway/
│   ├── GatewayServiceApplication.java    # 启动类
│   ├── config/
│   │   ├── CorsConfig.java               # CORS配置
│   │   └── Config.java                   # 过滤器配置类
│   ├── dto/
│   │   └── GatewayErrorResult.java       # 错误返回DTO
│   └── filter/
│       └── TokenValidateGatewayFilterFactory.java  # Token验证过滤器
└── src/main/resources/
    └── application-dev.yaml              # 路由配置
```

### 3.2 Admin 模块设计

#### 3.2.1 包结构

```
admin/src/main/java/com/xduo/shortlink/admin/
├── ShortLinkAdminApplication.java         # 启动类
├── common/                                # 公共组件
│   ├── biz/user/                          # 用户业务相关
│   │   ├── UserContext.java              # 用户上下文（ThreadLocal）
│   │   ├── UserInfoDTO.java              # 用户信息DTO
│   │   ├── UserTransmitFilter.java       # 用户信息传递过滤器
│   │   └── UserFlowRiskControlFilter.java # 用户流量风控过滤器
│   ├── convention/                       # 规范定义
│   │   ├── errorcode/                    # 错误码定义
│   │   ├── exception/                    # 异常定义
│   │   └── result/                       # 统一返回结果
│   ├── database/
│   │   └── BaseDO.java                   # 数据库实体基类
│   └── web/
│       └── GlobalExceptionHandler.java   # 全局异常处理
├── config/                                # 配置类
│   ├── DataBaseConfiguration.java        # 数据库配置
│   ├── MinIOConfig.java                  # MinIO配置
│   ├── UserConfiguration.java            # 用户配置
│   └── UserFlowRiskControlConfiguration.java # 流量风控配置
├── controller/                            # 控制器层
│   ├── UserController.java               # 用户管理
│   ├── GroupController.java              # 分组管理
│   ├── ShortLinkController.java          # 短链接管理
│   ├── RecycleBinController.java         # 回收站管理
│   └── ShortLinkStatsController.java     # 统计数据查询
├── service/                               # 服务层
│   ├── UserService.java
│   ├── GroupService.java
│   ├── RecycleBinService.java
│   ├── EmailService.java
│   └── impl/                              # 服务实现类
├── dao/                                   # 数据访问层
│   ├── entity/                            # 实体类
│   │   ├── UserDO.java
│   │   └── GroupDO.java
│   └── mapper/                            # Mapper接口
│       ├── UserMapper.java
│       └── GroupMapper.java
├── dto/                                   # 数据传输对象
│   ├── req/                               # 请求DTO
│   └── resp/                              # 响应DTO
└── remote/                                # 远程服务调用（OpenFeign）
    ├── ShortLinkActualRemoteService.java  # 调用Project服务
    └── dto/                                # 远程调用DTO
```

#### 3.2.2 核心功能模块

**用户管理模块**:
- 用户注册：邮箱验证码注册
- 用户登录：JWT Token 认证
- 个人信息管理：修改个人信息、头像上传
- 密码管理：修改密码、找回密码（邮箱验证）

**分组管理模块**:
- 创建分组：支持自定义分组名称
- 查询分组：分页查询用户分组列表
- 修改分组：修改分组名称和排序
- 删除分组：软删除机制

**短链接管理模块（管理端）**:
- 创建短链接：调用 Project 服务创建短链接
- 查询短链接：分页查询短链接列表
- 修改短链接：更新短链接信息
- 删除短链接：移至回收站

**回收站模块**:
- 移至回收站：软删除短链接
- 恢复短链接：从回收站恢复
- 彻底删除：永久删除短链接
- 分页查询回收站列表

#### 3.2.3 关键配置

**分库分表配置** (`shardingsphere-config-dev.yaml`):
- `t_user`: 16 个分表，按 `username` Hash 分片
- `t_group`: 16 个分表，按 `username` Hash 分片
- 数据加密：手机号、邮箱、密码使用 AES 加密

**用户流量风控**:
- 基于 Redis 的滑动窗口限流
- 支持配置时间窗口和最大访问次数
- 使用 Lua 脚本保证原子性

### 3.3 Project 模块设计

#### 3.3.1 包结构

```
project/src/main/java/com/xduo/shortlink/project/
├── ShortLinkApplication.java              # 启动类
├── common/                                # 公共组件
│   ├── constant/                         # 常量定义
│   ├── convention/                       # 规范定义
│   ├── database/
│   │   └── BaseDO.java                  # 数据库实体基类
│   └── web/
│       └── GlobalExceptionHandler.java  # 全局异常处理
├── config/                                # 配置类
│   ├── DateBaseConfiguration.java       # 数据库配置
│   ├── KafkaConfig.java                 # Kafka配置
│   ├── RBloomFilterConfiguration.java   # 布隆过滤器配置
│   ├── RedisStreamConfiguration.java    # Redis Stream配置
│   └── SentinelRuleConfig.java          # Sentinel限流配置
├── controller/                            # 控制器层
│   ├── ShortLinkController.java         # 短链接管理
│   ├── ShortLinkGoToController.java     # 短链接跳转
│   ├── ShortLinkStatsController.java    # 统计数据查询
│   ├── RecycleBinController.java        # 回收站管理
│   └── UrlTitleController.java          # URL标题获取
├── service/                               # 服务层
│   ├── LinkService.java                  # 短链接核心服务
│   ├── LinkGoToService.java              # 跳转服务
│   ├── ShortLinkStatsService.java       # 统计服务
│   ├── LinkAccessLogsService.java        # 访问日志服务
│   └── impl/                              # 服务实现类
├── dao/                                   # 数据访问层
│   ├── entity/                            # 实体类
│   │   ├── LinkDO.java                   # 短链接实体
│   │   ├── LinkGoToDO.java               # 跳转路由实体
│   │   ├── LinkAccessLogsDO.java         # 访问日志实体
│   │   ├── LinkAccessStatsDO.java        # 访问统计实体
│   │   └── ...                            # 其他统计实体
│   └── mapper/                            # Mapper接口
├── dto/                                   # 数据传输对象
│   ├── req/                               # 请求DTO
│   └── resp/                              # 响应DTO
├── mq/                                    # 消息队列
│   ├── producer/                          # 生产者
│   │   └── ShortLinkStatsKafkaProducer.java
│   ├── consumer/                          # 消费者
│   │   └── ShortLinkStatsKafkaConsumer.java
│   └── idempotent/                        # 幂等性处理
│       └── MessageQueueIdempotentHandler.java
└── util/                                  # 工具类
    ├── HashUtil.java                      # 哈希工具类
    └── LinkUtil.java                      # 链接工具类
```

#### 3.3.2 核心功能模块

**短链接生成模块**:
- 使用 MurmurHash 算法生成 6 位短链接后缀
- 布隆过滤器防止短链接重复（缓存穿透保护）
- 支持自定义短链接后缀（可选）
- 存储完整短链接信息到数据库和 Redis 缓存

**短链接跳转模块**:
- 高性能跳转服务，优先从 Redis 缓存获取
- 缓存击穿保护：使用分布式锁
- 缓存穿透保护：使用布隆过滤器
- 缓存预热：新创建的短链接立即缓存
- 支持有效期验证

**统计数据收集模块**:
- 使用 Kafka 异步处理统计数据
- 记录访问日志到 `t_link_access_logs` 表
- 统计数据包括：
  - 访问统计（PV、UV、UIP）
  - 地域统计（省份、城市）
  - 设备统计（PC、Mobile、Tablet）
  - 浏览器统计（Chrome、Firefox、Safari 等）
  - 操作系统统计（Windows、Mac、Linux 等）
  - 网络类型统计（WIFI、4G、5G 等）

**统计数据处理模块**:
- Kafka 消费者异步处理统计数据
- 批量写入统计数据表
- 支持幂等性处理，防止重复统计

#### 3.3.3 关键配置

**分库分表配置** (`shardingsphere-config-dev.yaml`):
- `t_link`: 16 个分表，按 `gid` Hash 分片
- `t_link_goto`: 16 个分表，按 `full_short_url` Hash 分片（跳转查询优化）
- `t_link_access_logs`: 64 个分表，按 `gid` Hash 分片
- `t_link_access_stats`: 32 个分表，按 `gid` Hash 分片
- 其他统计表：16 个分表，按 `gid` Hash 分片

**Kafka 配置**:
- Topic: `short-link-stats`
- 生产者配置：
  - ACKS: all（所有副本确认）
  - 重试次数: 3
  - 幂等性: true
  - 最大请求大小: 1MB
- 消费者配置：
  - 手动提交 offset
  - 批量拉取: max-poll-records=10
  - 自动重置偏移: earliest

---

## 4. 数据库设计

### 4.1 数据库分片策略

系统使用 ShardingSphere 进行分库分表，采用 HASH_MOD 算法进行数据分片。

#### 4.1.1 分表规则

| 表名 | 分表数量 | 分片键 | 说明 |
|------|---------|--------|------|
| t_user | 16 | username | 用户表 |
| t_group | 16 | username | 分组表 |
| t_link | 16 | gid | 短链接表 |
| t_link_goto | 16 | full_short_url | 跳转路由表 |
| t_link_access_logs | 64 | gid | 访问日志表 |
| t_link_access_stats | 32 | gid | 访问统计表 |
| t_link_browser_stats | 16 | gid | 浏览器统计表 |
| t_link_device_stats | 16 | gid | 设备统计表 |
| t_link_locale_stats | 16 | gid | 地区统计表 |
| t_link_network_stats | 16 | gid | 网络统计表 |
| t_link_os_stats | 16 | gid | 操作系统统计表 |
| t_link_stats_today | 16 | gid | 今日统计表 |

### 4.2 核心表结构

#### 4.2.1 用户表 (t_user_0~15)

```sql
CREATE TABLE `t_user_0` (
    `id`            bigint(20) NOT NULL AUTO_INCREMENT COMMENT 'ID',
    `gid`           varchar(32)  DEFAULT NULL COMMENT '分组标识',
    `username`      varchar(256) DEFAULT NULL COMMENT '用户名',
    `password`      varchar(512) DEFAULT NULL COMMENT '密码（加密）',
    `real_name`     varchar(256) DEFAULT NULL COMMENT '真实姓名',
    `phone`         varchar(128) DEFAULT NULL COMMENT '手机号（加密）',
    `mail`          varchar(512) DEFAULT NULL COMMENT '邮箱（加密）',
    `avatar`        varchar(512) DEFAULT NULL COMMENT '头像URL',
    `deletion_time` bigint(20) DEFAULT NULL COMMENT '注销时间戳',
    `create_time`   datetime     DEFAULT NULL COMMENT '创建时间',
    `update_time`   datetime     DEFAULT NULL COMMENT '修改时间',
    `del_flag`      tinyint(1) DEFAULT NULL COMMENT '删除标识 0：未删除 1：已删除',
    PRIMARY KEY (`id`),
    UNIQUE KEY `idx_unique_username` (`username`) USING BTREE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
```

**数据加密**:
- `phone`: AES 加密存储
- `mail`: AES 加密存储
- `password`: AES 加密存储

#### 4.2.2 分组表 (t_group_0~15)

```sql
CREATE TABLE `t_group_0` (
    `id`          bigint(20) NOT NULL AUTO_INCREMENT COMMENT 'ID',
    `gid`         varchar(32)  DEFAULT NULL COMMENT '分组标识',
    `name`        varchar(64)  DEFAULT NULL COMMENT '分组名称',
    `username`    varchar(256) DEFAULT NULL COMMENT '创建分组用户名',
    `sort_order`  int(3) DEFAULT NULL COMMENT '分组排序',
    `create_time` datetime     DEFAULT NULL COMMENT '创建时间',
    `update_time` datetime     DEFAULT NULL COMMENT '修改时间',
    `del_flag`    tinyint(1) DEFAULT NULL COMMENT '删除标识 0：未删除 1：已删除',
    PRIMARY KEY (`id`),
    KEY `idx_username` (`username`) USING BTREE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
```

#### 4.2.3 短链接表 (t_link_0~15)

```sql
CREATE TABLE `t_link_0` (
    `id`              bigint(20) NOT NULL AUTO_INCREMENT COMMENT 'ID',
    `domain`          varchar(128) DEFAULT NULL COMMENT '域名',
    `short_uri`       varchar(8) CHARACTER SET utf8 COLLATE utf8_bin DEFAULT NULL COMMENT '短链接',
    `full_short_url`  varchar(128) DEFAULT NULL COMMENT '完整短链接',
    `origin_url`      varchar(1024) DEFAULT NULL COMMENT '原始链接',
    `click_num`       int(11) DEFAULT '0' COMMENT '点击量',
    `gid`             varchar(32) DEFAULT 'default' COMMENT '分组标识',
    `favicon`         varchar(256) DEFAULT NULL COMMENT '网站图标',
    `enable_status`   tinyint(1) DEFAULT NULL COMMENT '启用标识 0：启用 1：未启用',
    `created_type`    tinyint(1) DEFAULT NULL COMMENT '创建类型 0：接口创建 1：控制台创建',
    `valid_date_type` tinyint(1) DEFAULT NULL COMMENT '有效期类型 0：永久有效 1：自定义',
    `valid_date`      datetime DEFAULT NULL COMMENT '有效期',
    `describe`        varchar(1024) DEFAULT NULL COMMENT '描述',
    `total_pv`        int(11) DEFAULT NULL COMMENT '历史PV',
    `total_uv`        int(11) DEFAULT NULL COMMENT '历史UV',
    `total_uip`       int(11) DEFAULT NULL COMMENT '历史UIP',
    `create_time`     datetime DEFAULT NULL COMMENT '创建时间',
    `update_time`     datetime DEFAULT NULL COMMENT '修改时间',
    `del_time`        bigint(20) DEFAULT '0' COMMENT '删除时间戳',
    `del_flag`        tinyint(1) DEFAULT NULL COMMENT '删除标识 0：未删除 1：已删除',
    PRIMARY KEY (`id`),
    UNIQUE KEY `idx_unique_full-short-url` (`full_short_url`,`del_time`) USING BTREE,
    KEY `idx_gid_status_del` (`gid`, `enable_status`, `del_flag`) USING BTREE,
    KEY `idx_gid_create_time` (`gid`, `create_time`) USING BTREE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
```

#### 4.2.4 跳转路由表 (t_link_goto_0~15)

```sql
CREATE TABLE `t_link_goto_0` (
    `id`             bigint(20) NOT NULL AUTO_INCREMENT COMMENT 'ID',
    `gid`            varchar(32)  DEFAULT 'default' COMMENT '分组标识',
    `full_short_url` varchar(128) DEFAULT NULL COMMENT '完整短链接',
    PRIMARY KEY (`id`),
    UNIQUE KEY `idx_full_short_url` (`full_short_url`) USING BTREE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
```

**设计说明**:
- 专门用于短链接跳转查询，优化查询性能
- 按 `full_short_url` 分片，用户访问时根据短链接直接定位到对应分表

#### 4.2.5 访问日志表 (t_link_access_logs_0~63)

```sql
CREATE TABLE `t_link_access_logs_0` (
    `id`             bigint(20) NOT NULL AUTO_INCREMENT COMMENT 'ID',
    `full_short_url` varchar(128) DEFAULT NULL COMMENT '完整短链接',
    `gid`            varchar(32)  DEFAULT NULL COMMENT '分组标识',
    `user`           varchar(64)  DEFAULT NULL COMMENT '用户信息',
    `ip`             varchar(64)  DEFAULT NULL COMMENT 'IP',
    `browser`        varchar(64)  DEFAULT NULL COMMENT '浏览器',
    `os`             varchar(64)  DEFAULT NULL COMMENT '操作系统',
    `network`        varchar(64)  DEFAULT NULL COMMENT '访问网络',
    `device`         varchar(64)  DEFAULT NULL COMMENT '访问设备',
    `locale`         varchar(256) DEFAULT NULL COMMENT '地区',
    `create_time`    datetime     DEFAULT NULL COMMENT '创建时间',
    `update_time`    datetime     DEFAULT NULL COMMENT '修改时间',
    `del_flag`       tinyint(1) DEFAULT NULL COMMENT '删除标识 0：未删除 1：已删除',
    PRIMARY KEY (`id`),
    KEY `idx_full_short_url` (`full_short_url`) USING BTREE,
    KEY `idx_gid` (`gid`) USING BTREE,
    KEY `idx_create_time` (`create_time`) USING BTREE,
    KEY `idx_gid_create_time` (`gid`, `create_time`) USING BTREE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
```

**设计说明**:
- 64 个分表，支持海量访问日志存储
- 索引优化：支持按 `gid`、`create_time` 查询

#### 4.2.6 访问统计表 (t_link_access_stats_0~31)

```sql
CREATE TABLE `t_link_access_stats_0` (
    `id`             bigint(20) NOT NULL AUTO_INCREMENT COMMENT 'ID',
    `full_short_url` varchar(128) DEFAULT NULL COMMENT '完整短链接',
    `gid`            varchar(32)  DEFAULT NULL COMMENT '分组标识',
    `date`           date         DEFAULT NULL COMMENT '日期',
    `pv`             int(11) DEFAULT NULL COMMENT '访问量',
    `uv`             int(11) DEFAULT NULL COMMENT '独立访客数',
    `uip`            int(11) DEFAULT NULL COMMENT '独立IP数',
    `hour`           int(3) DEFAULT NULL COMMENT '小时',
    `weekday`        int(3) DEFAULT NULL COMMENT '星期',
    `create_time`    datetime     DEFAULT NULL COMMENT '创建时间',
    `update_time`    datetime     DEFAULT NULL COMMENT '修改时间',
    `del_flag`       tinyint(1) DEFAULT NULL COMMENT '删除标识 0：未删除 1：已删除',
    PRIMARY KEY (`id`),
    UNIQUE KEY `idx_unique_access_stats` (`gid`,`full_short_url`,`date`,`hour`),
    KEY `idx_gid_date` (`gid`, `date`) USING BTREE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
```

#### 4.2.7 其他统计表

系统还包含以下统计表，用于不同维度的数据分析：

- `t_link_browser_stats`: 浏览器统计（Chrome、Firefox、Safari 等）
- `t_link_device_stats`: 设备统计（PC、Mobile、Tablet）
- `t_link_locale_stats`: 地区统计（省份、城市）
- `t_link_network_stats`: 网络类型统计（WIFI、4G、5G）
- `t_link_os_stats`: 操作系统统计（Windows、Mac、Linux）
- `t_link_stats_today`: 今日统计（实时统计数据）

所有统计表均采用 16 个分表，按 `gid` Hash 分片。

### 4.3 索引优化

系统对关键表添加了复合索引，优化查询性能：

- `t_link_access_logs`: `idx_gid_create_time`（gid + create_time）
- `t_link`: `idx_gid_status_del`（gid + enable_status + del_flag）
- `t_link`: `idx_gid_create_time`（gid + create_time）
- 所有统计表: `idx_gid_date`（gid + date）

---

## 5. 核心功能设计

### 5.1 短链接生成

#### 5.1.1 生成算法

使用 **MurmurHash** 算法生成短链接后缀：

1. 将原始 URL + UUID 拼接作为输入
2. 使用 MurmurHash 算法计算哈希值
3. 将哈希值转换为 Base62 编码（0-9, a-z, A-Z）
4. 截取前 6 位作为短链接后缀

**优势**:
- 算法快速，性能优异
- 哈希分布均匀，冲突概率低
- Base62 编码，字符集友好

#### 5.1.2 防重复机制

1. **布隆过滤器**: 
   - 使用 Redis 布隆过滤器快速判断短链接是否已存在
   - 如果布隆过滤器判断不存在，则一定不存在
   - 如果判断存在，需要进一步验证

2. **数据库唯一索引**:
   - `t_link` 表设置 `full_short_url + del_time` 唯一索引
   - 插入时捕获 `DuplicateKeyException` 异常

3. **重试机制**:
   - 如果生成失败，重新生成（最多重试 10 次）

#### 5.1.3 流程设计

```
1. 验证原始URL白名单
2. 生成短链接后缀（使用Hash算法）
3. 检查布隆过滤器
   ├─ 不存在 → 继续
   └─ 存在 → 重新生成
4. 插入数据库
   ├─ 成功 → 写入缓存、更新布隆过滤器
   └─ 失败（唯一索引冲突）→ 重新生成
5. 返回完整短链接
```

### 5.2 短链接跳转

#### 5.2.1 跳转流程

```
用户访问短链接
    ↓
Gateway 路由到 Project 服务
    ↓
1. 从 Redis 缓存查询
   ├─ 缓存命中 → 返回原始链接（302重定向）
   └─ 缓存未命中 → 继续
2. 检查缓存穿透标记
   ├─ 标记存在 → 返回404页面
   └─ 标记不存在 → 继续
3. 获取分布式锁（防止缓存击穿）
4. 双重检查缓存（Double Check）
   ├─ 缓存存在 → 返回原始链接
   └─ 缓存不存在 → 继续
5. 查询数据库（t_link_goto表）
   ├─ 存在 → 写入缓存、更新统计、返回原始链接
   └─ 不存在 → 写入缓存穿透标记、返回404
6. 释放分布式锁
```

#### 5.2.2 性能优化

1. **Redis 缓存**:
   - 使用 Hash 结构存储短链接信息
   - 缓存过期时间：30 天
   - 缓存键: `short-link:goto:hash:{fullShortUrl}`

2. **缓存穿透保护**:
   - 使用布隆过滤器预判短链接是否存在
   - 缓存穿透标记: `short-link:goto:is-null:{fullShortUrl}`

3. **缓存击穿保护**:
   - 使用 Redisson 分布式锁
   - 锁键: `short-link:goto:lock:{fullShortUrl}`
   - 锁超时时间: 10 秒

4. **查询优化**:
   - 使用 `t_link_goto` 表快速查询（按 `full_short_url` 分片）
   - 分离跳转路由表和业务表，提高查询性能

### 5.3 统计数据收集

#### 5.3.1 统计维度

系统收集以下维度的统计数据：

1. **基础统计**:
   - PV（Page View）: 页面访问量
   - UV（Unique Visitor）: 独立访客数
   - UIP（Unique IP）: 独立IP数

2. **地域统计**:
   - 省份统计
   - 城市统计
   - 使用高德地图API解析IP地址

3. **设备统计**:
   - PC、Mobile、Tablet

4. **浏览器统计**:
   - Chrome、Firefox、Safari、Edge 等

5. **操作系统统计**:
   - Windows、Mac、Linux、iOS、Android 等

6. **网络类型统计**:
   - WIFI、4G、5G、3G 等

#### 5.3.2 数据收集流程

```
用户访问短链接
    ↓
记录访问日志（异步）
    ↓
发送统计消息到 Kafka
    ↓
Kafka 消费者异步处理
    ↓
1. 解析访问日志
   - IP地址解析（地域信息）
   - User-Agent解析（浏览器、设备、OS）
2. 更新统计表
   - t_link_access_stats（基础统计）
   - t_link_browser_stats（浏览器统计）
   - t_link_device_stats（设备统计）
   - t_link_locale_stats（地区统计）
   - t_link_network_stats（网络统计）
   - t_link_os_stats（操作系统统计）
   - t_link_stats_today（今日统计）
3. 手动提交 offset
```

#### 5.3.3 Kafka 消息设计

**Topic**: `short-link-stats`

**消息格式**:
```json
{
  "fullShortUrl": "http://xDuo.top/abc123",
  "gid": "gid123",
  "user": "user123",
  "ip": "192.168.1.1",
  "browser": "Chrome",
  "os": "Windows",
  "network": "WIFI",
  "device": "PC",
  "locale": "北京市-北京市",
  "timestamp": 1704067200000
}
```

**生产者配置**:
- 使用 `full_short_url` 作为消息 Key，保证同一短链接的消息有序
- ACKS=all：确保消息可靠发送
- 幂等性：防止重复消息

**消费者配置**:
- 手动提交 offset：确保消息处理完成后再提交
- 批量消费：max-poll-records=10
- 幂等性处理：防止重复统计

### 5.4 用户认证与授权

#### 5.4.1 登录流程

```
1. 用户提交登录请求（username + password）
2. Admin 服务验证用户名和密码
3. 生成 Token（UUID）
4. 存储 Token 到 Redis
   - Key: short-link:login:{username}
   - Hash 字段: token → 用户信息（JSON）
   - 过期时间: 30 天
5. 返回 Token 给前端
6. 前端存储 Token，后续请求携带 Token
```

#### 5.4.2 Token 验证流程

```
1. Gateway 拦截请求
2. 检查请求路径是否在白名单
   ├─ 在白名单 → 放行
   └─ 不在白名单 → 继续验证
3. 从请求头获取 username 和 token
4. 从 Redis 验证 Token
   ├─ 验证通过 → 注入用户信息到请求头，转发到下游服务
   └─ 验证失败 → 返回 401 未授权
5. 下游服务从请求头获取用户信息（userId, realName）
```

#### 5.4.3 用户上下文传递

使用 ThreadLocal 存储用户信息（基于 TransmittableThreadLocal）：

```java
// Admin 服务
UserContext.setUser(userInfo);  // 设置用户上下文

// 在业务代码中获取
String userId = UserContext.getUserId();
String username = UserContext.getUsername();
```

### 5.5 流量风控

#### 5.5.1 用户操作限流

使用 Redis Lua 脚本实现滑动窗口限流：

1. **Lua 脚本** (`user_flow_risk_control.lua`):
   - 滑动窗口：1 分钟
   - 最大访问次数：20 次

2. **限流维度**:
   - 按用户（username）
   - 按接口路径（requestPath）

3. **限流处理**:
   - 超过限制 → 返回 429 状态码
   - 记录限流日志

#### 5.5.2 配置

```yaml
short-link:
  flow-limit:
    enable: true          # 是否启用流量限制
    time-window: 1       # 时间窗口（分钟）
    max-access-count: 20 # 最大访问次数
```

---

## 6. 技术栈

### 6.1 框架与工具

| 技术 | 版本 | 用途 |
|------|------|------|
| Spring Boot | 3.0.7 | 应用框架 |
| Spring Cloud | 2022.0.3 | 微服务框架 |
| Spring Cloud Alibaba | 2022.0.0.0-RC2 | 阿里微服务组件 |
| MyBatis Plus | 3.5.3.1 | ORM 框架 |
| ShardingSphere | 5.3.2 | 分库分表 |
| Redisson | 3.21.3 | Redis 客户端、分布式锁、布隆过滤器 |
| Kafka | 7.4.0 | 消息队列 |
| Nacos | 2.4.2 | 服务注册与配置中心 |
| Sentinel | - | 限流降级 |

### 6.2 中间件

| 中间件 | 版本 | 用途 |
|--------|------|------|
| MySQL | 8.0 | 数据库 |
| Redis | 7 | 缓存、分布式锁、布隆过滤器 |
| Kafka | 7.4.0 | 消息队列 |
| MinIO | - | 对象存储 |
| Zookeeper | - | Kafka 依赖 |

### 6.3 工具库

| 工具库 | 版本 | 用途 |
|--------|------|------|
| Hutool | 5.8.20 | Java 工具类库 |
| Fastjson2 | 2.0.36 | JSON 处理 |
| Jsoup | 1.17.2 | HTML 解析（获取网站图标） |
| EasyExcel | 4.0.3 | Excel 处理 |

---

## 7. 部署架构

### 7.1 服务端口

| 服务 | 端口 | 说明 |
|------|------|------|
| Gateway | 8000 | 网关服务 |
| Project | 8001 | 核心业务服务 |
| Admin | 8002 | 管理服务 |

### 7.2 中间件端口

| 中间件 | 端口 | 说明 |
|--------|------|------|
| MySQL | 3306 | 数据库 |
| Redis | 6379 | 缓存 |
| Kafka | 9092 | 消息队列 |
| Zookeeper | 2181 | Kafka 依赖 |
| MinIO | 9000/9001 | 对象存储 |
| Nacos | 8848 | 服务注册中心 |

### 7.3 服务启动顺序

1. **启动中间件服务**（通过 Docker Compose）:
   - MySQL
   - Redis
   - Zookeeper
   - Kafka
   - MinIO
   - Nacos

2. **启动后端服务**:
   - Gateway 服务
   - Project 服务
   - Admin 服务

3. **验证服务**:
   - 检查 Nacos 控制台，确认服务已注册
   - 检查服务健康状态

### 7.4 Docker Compose 部署

系统提供了完整的 Docker Compose 配置，支持一键启动所有中间件服务：

```yaml
services:
  mysql:
    image: mysql:8.0
    ports:
      - "3306:3306"
  
  redis:
    image: redis:7
    ports:
      - "6379:6379"
  
  zookeeper:
    image: zookeeper:3.8
    ports:
      - "2181:2181"
  
  kafka:
    image: confluentinc/cp-kafka:7.4.0
    ports:
      - "9092:9092"
  
  minio:
    image: minio/minio
    ports:
      - "9000:9000"
      - "9001:9001"
  
  nacos:
    image: nacos/nacos-server:v2.4.2
    ports:
      - "8848:8848"
```

---

## 8. 性能优化

### 8.1 缓存策略

1. **多级缓存**:
   - Redis 缓存：存储热点数据
   - 布隆过滤器：防止缓存穿透

2. **缓存预热**:
   - 短链接创建后立即缓存
   - 热点数据定期刷新

3. **缓存更新**:
   - 短链接修改时更新缓存
   - 使用分布式锁保证一致性

### 8.2 数据库优化

1. **分库分表**:
   - 按业务维度分片
   - 支持水平扩展

2. **索引优化**:
   - 复合索引优化查询
   - 覆盖索引减少回表

3. **查询优化**:
   - 分离跳转路由表，优化查询路径
   - 使用批量操作减少数据库交互

### 8.3 异步处理

1. **统计数据异步处理**:
   - 使用 Kafka 异步处理统计数据
   - 不影响用户访问性能

2. **批量写入**:
   - Kafka 消费者批量处理消息
   - 减少数据库写入次数

---

## 9. 安全设计

### 9.1 数据加密

1. **敏感数据加密**:
   - 用户手机号、邮箱、密码使用 AES 加密
   - 加密算法: AES-128
   - 加密密钥: 通过 ShardingSphere 配置

2. **密码安全**:
   - 密码使用 AES 加密存储
   - 不支持明文密码查询

### 9.2 访问控制

1. **Token 认证**:
   - 所有接口（除白名单）需要 Token 验证
   - Token 存储在 Redis，支持过期失效

2. **流量限制**:
   - 用户操作限流，防止恶意请求
   - 基于滑动窗口算法

### 9.3 白名单机制

1. **域名白名单**:
   - 短链接跳转目标域名白名单检查
   - 防止恶意跳转

2. **接口白名单**:
   - 登录、注册等公开接口不验证 Token

---

## 10. 监控与日志

### 10.1 日志规范

1. **日志级别**:
   - ERROR: 系统错误、异常
   - WARN: 警告信息（如短链接重复）
   - INFO: 关键操作日志
   - DEBUG: 调试信息

2. **日志格式**:
   - 统一日志格式，包含请求ID、用户信息等

### 10.2 异常处理

1. **全局异常处理**:
   - `GlobalExceptionHandler` 统一处理异常
   - 返回统一格式的错误响应

2. **异常分类**:
   - `ClientException`: 客户端错误
   - `ServiceException`: 服务端错误
   - `RemoteException`: 远程调用错误

---

## 11. 扩展性设计

### 11.1 水平扩展

1. **服务扩展**:
   - 服务无状态设计，支持水平扩展
   - Nacos 实现负载均衡

2. **数据库扩展**:
   - 分库分表支持数据水平扩展
   - 可按业务需求增加分片数量

### 11.2 功能扩展

1. **插件化设计**:
   - 统计维度可扩展
   - 支持自定义统计指标

2. **接口扩展**:
   - 统一的 DTO 规范
   - 统一的返回格式

---

## 12. 总结

本系统采用微服务架构，通过合理的模块划分、数据库分片、缓存优化等技术手段，实现了高性能、高可用的短链接管理系统。系统支持水平扩展，能够应对高并发访问场景，并提供了完善的统计和分析功能。

### 12.1 核心亮点

1. **高性能**: 缓存优化、异步处理、数据库分片
2. **高可用**: 分布式锁、幂等性处理、异常处理
3. **可扩展**: 微服务架构、分库分表、水平扩展
4. **安全性**: 数据加密、Token 认证、流量限制

### 12.2 改进方向

1. **监控体系**: 集成 Prometheus + Grafana 监控
2. **链路追踪**: 集成 SkyWalking 或 Zipkin
3. **日志收集**: 集成 ELK 日志收集系统
4. **服务治理**: 完善 Sentinel 限流降级规则

---

**文档版本**: v1.0  
**最后更新**: 2024年  
**维护人员**: 开发团队

