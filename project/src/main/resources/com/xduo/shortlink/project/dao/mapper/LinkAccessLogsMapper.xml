<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.xduo.shortlink.project.dao.mapper.LinkAccessLogsMapper">


    <select id="listTopIpByShortLink" resultType="java.util.HashMap">
        SELECT
        ip,
        COUNT(ip) AS count
        FROM
        t_link_access_logs
        WHERE
        full_short_url = #{fullShortUrl}
        AND gid = #{gid}
        AND create_time BETWEEN #{startDate} AND #{endDate}
        GROUP BY
        full_short_url, gid, ip
        ORDER BY
        count DESC
        LIMIT 5;
    </select>
    <select id="findUvTypeCntByShortLink" resultType="java.util.HashMap">
        SELECT
        COALESCE(SUM(CASE WHEN uvType = '新访客' THEN 1 ELSE 0 END), 0) AS newUserCnt,
        COALESCE(SUM(CASE WHEN uvType = '老访客' THEN 1 ELSE 0 END), 0) AS oldUserCnt
        FROM (
            SELECT
            user,
            CASE
            WHEN MIN(create_time) BETWEEN #{param.startDate} AND #{param.endDate} THEN '新访客'
            ELSE '老访客'
            END AS uvType
            FROM t_link_access_logs
            WHERE full_short_url = #{param.fullShortUrl}
            AND gid = #{param.gid}
            AND create_time BETWEEN #{param.startDate} AND #{param.endDate}
            GROUP BY user
        ) AS uv_stats
    </select>
    <select id="selectUvTypeByUser" resultType="java.util.Map">
        SELECT
        user,
        create_time,
        CASE
        WHEN create_time = (SELECT MIN(create_time)
        FROM t_link_access_logs
        WHERE user = t.user
        AND full_short_url = #{fullShortUrl}
        AND gid = #{gid}
        AND create_time BETWEEN #{startDate} AND #{endDate}) THEN '新访客'
        ELSE '老访客'
        END AS uvType
        FROM
        t_link_access_logs t
        WHERE
        full_short_url = #{fullShortUrl}
        AND gid = #{gid}
        AND create_time BETWEEN #{startDate} AND #{endDate}
        AND user IN
        <foreach item="item" index="index" collection="userAccessLogsList" open="(" separator="," close=")">
            #{item}
        </foreach>
    </select>
    <select id="listGroupTopIpByShortLink" resultType="java.util.HashMap">
        SELECT
        ip,
        COUNT(ip) AS count
        FROM
        t_link_access_logs
        WHERE
        gid = #{gid}
        AND create_time BETWEEN #{startDate} AND #{endDate}
        GROUP BY
        gid, ip
        ORDER BY
        count DESC
        LIMIT 5;

    </select>
    <select id="findGroupUvTypeCntByShortLink" resultType="java.util.HashMap">
        select * from t_link_access_logs
    </select>
    <select id="selectGroupUvTypeByUser" resultType="java.util.Map">
        select * from t_link_access_logs
    </select>

</mapper>

