<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.xduo.shortlink.project.dao.mapper.LinkAccessLogsMapper">


    <select id="listTopIpByShortLink" resultType="java.util.HashMap">
        SELECT
        ip,
        COUNT(ip) AS count
        FROM
        t_link_access_logs lal
        WHERE
        lal.full_short_url = #{fullShortUrl}
        AND lal.gid = #{gid}
        AND lal.create_time BETWEEN #{startDate} AND #{endDate}
        GROUP BY
        lal.full_short_url, lal.gid, lal.ip
        ORDER BY
        count DESC
        LIMIT 5;
    </select>
    <!-- 简化查询：获取指定短链接在指定时间范围内的所有用户访问记录 -->
    <select id="findUserAccessLogsByShortLink" resultType="java.util.HashMap">
        SELECT
        user,
        MIN(create_time) as first_access_time,
        MAX(create_time) as last_access_time
        FROM t_link_access_logs
        WHERE full_short_url = #{fullShortUrl}
        AND gid = #{gid}
        AND create_time BETWEEN #{startDate} AND #{endDate}
        GROUP BY user
    </select>
    <!-- 简化查询：获取指定用户的访问记录 -->
    <select id="selectUserAccessLogs" resultType="java.util.Map">
        SELECT
        user,
        create_time,
        ip,
        browser,
        os,
        device,
        network,
        locale
        FROM t_link_access_logs
        WHERE full_short_url = #{fullShortUrl}
        AND gid = #{gid}
        AND create_time BETWEEN #{startDate} AND #{endDate}
        <if test="userAccessLogsList != null and userAccessLogsList.size() &gt; 0">
            AND user IN
            <foreach item="item" index="index" collection="userAccessLogsList" open="(" separator="," close=")">
                #{item}
            </foreach>
        </if>
        ORDER BY create_time ASC
    </select>
    <select id="listGroupTopIpByShortLink" resultType="java.util.HashMap">
        SELECT
        ip,
        COUNT(ip) AS count
        FROM
        t_link_access_logs lal
        WHERE
        lal.gid = #{gid}
        AND lal.create_time BETWEEN #{startDate} AND #{endDate}
        GROUP BY
        lal.gid, lal.ip
        ORDER BY
        count DESC
        LIMIT 5;
    </select>
    <!-- 简化查询：获取分组在指定时间范围内的所有用户访问记录 -->
    <select id="findGroupUserAccessLogs" resultType="java.util.HashMap">
        SELECT
        user,
        MIN(create_time) as first_access_time,
        MAX(create_time) as last_access_time
        FROM t_link_access_logs
        WHERE gid = #{gid}
        AND create_time BETWEEN #{startDate} AND #{endDate}
        GROUP BY user
    </select>
    <!-- 简化查询：获取分组指定用户的访问记录 -->
    <select id="selectGroupUserAccessLogs" resultType="java.util.Map">
        SELECT
        user,
        create_time,
        ip,
        browser,
        os,
        device,
        network,
        locale
        FROM t_link_access_logs
        WHERE gid = #{gid}
        AND create_time BETWEEN #{startDate} AND #{endDate}
        <if test="userAccessLogsList != null and userAccessLogsList.size() &gt; 0">
            AND user IN
            <foreach item="item" index="index" collection="userAccessLogsList" open="(" separator="," close=")">
                #{item}
            </foreach>
        </if>
        ORDER BY create_time ASC
    </select>

</mapper>

