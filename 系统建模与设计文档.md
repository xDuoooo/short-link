# 短链接系统建模与设计文档

## 目录

1. [系统目标与框架](#1-系统目标与框架)
2. [UML建模](#2-uml建模)
   - [2.1 用例图](#21-用例图)
   - [2.2 类图](#22-类图)
   - [2.3 时序图](#23-时序图)
   - [2.4 活动图](#24-活动图)
   - [2.5 状态图](#25-状态图)
   - [2.6 组件图](#26-组件图)
   - [2.7 部署图](#27-部署图)
   - [2.8 包图](#28-包图)

---

## 1. 系统目标与框架

### 1.1 系统目标

#### 1.1.1 业务目标

**核心业务目标**
- 提供高效、稳定的短链接生成和管理服务
- 支持大规模并发访问，处理能力达到10万+ QPS
- 提供详细的访问统计和分析功能
- 保障用户数据安全和隐私保护

**扩展业务目标**
- 支持API接口调用，方便第三方集成
- 提供分组管理功能，便于链接分类
- 支持批量操作，提高管理效率
- 提供数据导出功能，支持数据分析

#### 1.1.2 技术目标

**性能目标**
- 短链接跳转响应时间 < 100ms
- 短链接创建响应时间 < 500ms
- 系统可用性达到99.9%以上
- 支持千万级数据存储

**架构目标**
- 采用微服务架构，实现服务解耦
- 支持水平扩展，提高系统弹性
- 采用分库分表，支持海量数据存储
- 实现高可用设计，保障系统稳定性

**安全目标**
- 敏感数据加密存储和传输
- 实现完善的访问控制和权限管理
- 提供安全审计和日志记录功能
- 防止常见的安全攻击（SQL注入、XSS等）

### 1.2 系统框架

#### 1.2.1 总体架构

```plantuml
@startuml
title 短链接系统总体架构

package "表现层" {
    [React前端应用]
    [Web管理界面]
    [移动端应用]
}

package "网关层" {
    [Spring Cloud Gateway]
    [路由转发]
    [Token验证]
    [限流降级]
}

package "业务服务层" {
    package "管理服务" {
        [用户管理服务]
        [分组管理服务]
        [短链接管理服务]
        [回收站服务]
    }
    
    package "项目服务" {
        [短链接生成服务]
        [短链接跳转服务]
        [统计分析服务]
        [访问日志服务]
    }
}

package "中间件层" {
    [Nacos注册中心]
    [Redis缓存]
    [Kafka消息队列]
    [MinIO对象存储]
}

package "数据层" {
    [MySQL数据库]
    [分库分表]
    [数据备份]
}

[React前端应用] --> [Spring Cloud Gateway]
[Spring Cloud Gateway] --> [用户管理服务]
[Spring Cloud Gateway] --> [短链接生成服务]
[用户管理服务] --> [Nacos注册中心]
[短链接生成服务] --> [Nacos注册中心]
[用户管理服务] --> [Redis缓存]
[短链接生成服务] --> [Redis缓存]
[短链接生成服务] --> [Kafka消息队列]
[统计分析服务] --> [MySQL数据库]
[用户管理服务] --> [MySQL数据库]
@enduml
```

#### 1.2.2 技术架构

**前端技术栈**
- React 18.2.0 + TypeScript
- Ant Design 5.12.8
- Redux Toolkit 2.0.1
- React Router DOM 6.20.1

**后端技术栈**
- Spring Boot 3.0.7
- Spring Cloud 2022.0.3
- Spring Cloud Alibaba 2022.0.0.0-RC2
- MyBatis Plus 3.5.3.1

**中间件技术**
- Nacos 2.4.2（服务注册与配置中心）
- Redis 7（缓存）
- Kafka 7.4.0（消息队列）
- MySQL 8.0（数据库）
- ShardingSphere 5.3.2（分库分表）
- MinIO（对象存储）

#### 1.2.3 分层架构

**表现层（Presentation Layer）**
- 负责用户界面展示和交互
- 接收用户输入并调用后端接口
- 处理前端路由和状态管理

**网关层（Gateway Layer）**
- 统一入口，路由转发
- 身份认证和授权
- 限流降级和熔断

**业务服务层（Service Layer）**
- 业务逻辑处理
- 数据访问和缓存管理
- 消息队列和异步处理

**数据层（Data Layer）**
- 数据持久化存储
- 数据访问和查询优化
- 数据备份和恢复

---

## 2. UML建模

### 2.1 用例图

#### 2.1.1 系统用例图

```plantuml
@startuml
title 短链接系统用例图

left to right direction

actor 用户 as User
actor 管理员 as Admin
actor 系统 as System

rectangle "短链接系统" {
    usecase "用户注册" as UC1
    usecase "用户登录" as UC2
    usecase "修改个人信息" as UC3
    usecase "修改密码" as UC4
    usecase "创建短链接" as UC5
    usecase "查看短链接" as UC6
    usecase "修改短链接" as UC7
    usecase "删除短链接" as UC8
    usecase "访问短链接" as UC9
    usecase "创建分组" as UC10
    usecase "管理分组" as UC11
    usecase "查看统计信息" as UC12
    usecase "导出统计数据" as UC13
    usecase "恢复短链接" as UC14
    usecase "批量创建短链接" as UC15
    usecase "系统监控" as UC16
    usecase "用户管理" as UC17
}

User --> UC1
User --> UC2
User --> UC3
User --> UC4
User --> UC5
User --> UC6
User --> UC7
User --> UC8
User --> UC10
User --> UC11
User --> UC12
User --> UC13
User --> UC15

System --> UC9
System --> UC14

Admin --> UC16
Admin --> UC17

UC5 ..> UC10 : <<include>>
UC6 ..> UC11 : <<include>>
UC12 ..> UC12 : <<include>>
@enduml
```

#### 2.1.2 用户管理用例图

```plantuml
@startuml
title 用户管理用例图

actor 用户 as User
actor 邮件系统 as Email

rectangle "用户管理" {
    usecase "注册账号" as Register
    usecase "发送验证码" as SendCode
    usecase "验证邮箱" as VerifyEmail
    usecase "用户登录" as Login
    usecase "查看个人信息" as ViewProfile
    usecase "修改个人信息" as UpdateProfile
    usecase "上传头像" as UploadAvatar
    usecase "修改密码" as ChangePassword
    usecase "找回密码" as ForgotPassword
    usecase "退出登录" as Logout
}

User --> Register
User --> Login
User --> ViewProfile
User --> UpdateProfile
User --> UploadAvatar
User --> ChangePassword
User --> ForgotPassword
User --> Logout

Register ..> SendCode : <<include>>
Register ..> VerifyEmail : <<include>>
ForgotPassword ..> SendCode : <<include>>

Email --> SendCode
Email --> VerifyEmail
@enduml
```

#### 2.1.3 短链接管理用例图

```plantuml
@startuml
title 短链接管理用例图

actor 用户 as User
actor 访客 as Visitor

rectangle "短链接管理" {
    usecase "创建短链接" as CreateLink
    usecase "批量创建短链接" as BatchCreate
    usecase "查看短链接列表" as ViewList
    usecase "查看短链接详情" as ViewDetail
    usecase "修改短链接" as UpdateLink
    usecase "删除短链接" as DeleteLink
    usecase "访问短链接" as AccessLink
    usecase "启用/禁用短链接" as EnableDisable
    usecase "查看访问统计" as ViewStats
    usecase "导出统计数据" as ExportStats
}

User --> CreateLink
User --> BatchCreate
User --> ViewList
User --> ViewDetail
User --> UpdateLink
User --> DeleteLink
User --> EnableDisable
User --> ViewStats
User --> ExportStats

Visitor --> AccessLink

CreateLink ..> ViewList : <<extend>>
AccessLink ..> ViewStats : <<include>>
@enduml
```

### 2.2 类图

#### 2.2.1 核心实体类图

```plantuml
@startuml
title 核心实体类图

class BaseDO {
    + Date createTime
    + Date updateTime
    + Integer delFlag
}

class UserDO {
    + Long id
    + String username
    + String password
    + String realName
    + String phone
    + String mail
    + String avatar
    + Long deletionTime
}

class GroupDO {
    + Long id
    + String gid
    + String name
    + String username
    + Integer sortOrder
}

class LinkDO {
    + Long id
    + String domain
    + String shortUri
    + String fullShortUrl
    + String originUrl
    + Integer clickNum
    + String gid
    + Integer enableStatus
    + Integer createdType
    + Integer validDateType
    + Date validDate
    + String describe
    + String favicon
    + Integer totalPv
    + Integer totalUv
    + Integer totalUip
}

class LinkAccessLogsDO {
    + Long id
    + String fullShortUrl
    + String gid
    + String user
    + String ip
    + String browser
    + String os
    + String network
    + String device
    + String locale
}

class LinkAccessStatsDO {
    + Long id
    + String fullShortUrl
    + String gid
    + Date date
    + Integer pv
    + Integer uv
    + Integer uip
    + Integer hour
    + Integer weekday
}

BaseDO <|-- UserDO
BaseDO <|-- GroupDO
BaseDO <|-- LinkDO
BaseDO <|-- LinkAccessLogsDO
BaseDO <|-- LinkAccessStatsDO

UserDO "1" --> "*" GroupDO : 创建
GroupDO "1" --> "*" LinkDO : 包含
LinkDO "1" --> "*" LinkAccessLogsDO : 产生
LinkDO "1" --> "*" LinkAccessStatsDO : 统计
@enduml
```

#### 2.2.2 服务层类图

```plantuml
@startuml
title 服务层类图

interface IService<T> {
    + save(T entity)
    + updateById(T entity)
    + removeById(Serializable id)
    + getById(Serializable id)
}

interface UserService {
    + UserRespDTO getUserByUsername(String username)
    + Boolean hasUsername(String username)
    + void register(UserRegisterReqDTO dto)
    + void update(UserUpdateReqDTO dto)
    + UserLoginRespDTO login(UserLoginReqDTO dto)
    + Boolean checkLogin(String username, String token)
    + void logout(String username, String token)
    + void changePassword(UserChangePasswordReqDTO dto)
    + void sendEmailCode(SendEmailCodeReqDTO dto)
}

interface GroupService {
    + void saveGroup(GroupSaveReqDTO dto)
    + List<GroupRespDTO> listGroup()
    + void updateGroup(GroupUpdateReqDTO dto)
    + void deleteGroup(String gid)
}

interface LinkService {
    + ShortLinkCreateRespDTO createShortLink(ShortLinkCreateReqDTO dto)
    + IPage<ShortLinkPageRespDTO> pageShortLink(ShortLinkPageReqDTO dto)
    + ShortLinkBatchPageRespDTO batchPageShortLink(ShortLinkBatchPageReqDTO dto)
    + void updateShortLink(ShortLinkUpdateReqDTO dto)
    + void restoreUrl(String shortUri, HttpServletRequest request, HttpServletResponse response)
    + ShortLinkBatchCreateRespDTO batchCreateShortLink(ShortLinkBatchCreateReqDTO dto)
    + void shortLinkStats(String fullShortUrl, String gid, ShortLinkStatsRecordDTO dto)
}

interface ShortLinkStatsService {
    + ShortLinkStatsRespDTO getOneShortLinkStats(ShortLinkStatsReqDTO dto)
    + ShortLinkStatsRespDTO getGroupShortLinkStats(ShortLinkStatsReqDTO dto)
    + IPage<ShortLinkStatsAccessRecordRespDTO> getShortLinkStatsAccessRecord(ShortLinkStatsAccessRecordReqDTO dto)
}

class UserServiceImpl {
    - UserMapper userMapper
    - RedisTemplate<String, Object> redisTemplate
    - EmailService emailService
    + UserRespDTO getUserByUsername(String username)
    + void register(UserRegisterReqDTO dto)
    + UserLoginRespDTO login(UserLoginReqDTO dto)
}

class GroupServiceImpl {
    - GroupMapper groupMapper
    + void saveGroup(GroupSaveReqDTO dto)
    + List<GroupRespDTO> listGroup()
}

class LinkServiceImpl {
    - LinkMapper linkMapper
    - LinkGoToMapper linkGoToMapper
    - RBloomFilter<String> shortUriCreateCachePenetrationBloomFilter
    - StringRedisTemplate stringRedisTemplate
    - KafkaProducer kafkaProducer
    + ShortLinkCreateRespDTO createShortLink(ShortLinkCreateReqDTO dto)
    + void restoreUrl(String shortUri, HttpServletRequest request, HttpServletResponse response)
}

class ShortLinkStatsServiceImpl {
    - LinkAccessStatsMapper linkAccessStatsMapper
    - LinkBrowserStatsMapper linkBrowserStatsMapper
    - LinkDeviceStatsMapper linkDeviceStatsMapper
    - LinkLocaleStatsMapper linkLocaleStatsMapper
    - LinkNetworkStatsMapper linkNetworkStatsMapper
    - LinkOsStatsMapper linkOsStatsMapper
    - LinkAccessLogsMapper linkAccessLogsMapper
    + ShortLinkStatsRespDTO getOneShortLinkStats(ShortLinkStatsReqDTO dto)
}

IService <|.. UserService
IService <|.. LinkService
UserService <|.. UserServiceImpl
GroupService <|.. GroupServiceImpl
LinkService <|.. LinkServiceImpl
ShortLinkStatsService <|.. ShortLinkStatsServiceImpl

UserServiceImpl --> UserService
LinkServiceImpl --> LinkService
ShortLinkStatsServiceImpl --> ShortLinkStatsService
@enduml
```

#### 2.2.3 DTO类图

```plantuml
@startuml
title DTO类图

class UserRegisterReqDTO {
    + String username
    + String password
    + String realName
    + String phone
    + String mail
    + String emailCode
}

class UserLoginReqDTO {
    + String username
    + String password
}

class UserLoginRespDTO {
    + String username
    + String token
    + UserRespDTO userInfo
}

class UserRespDTO {
    + String username
    + String realName
    + String phone
    + String mail
    + String avatar
}

class ShortLinkCreateReqDTO {
    + String originUrl
    + String gid
    + Integer createdType
    + Integer validDateType
    + Date validDate
    + String describe
}

class ShortLinkCreateRespDTO {
    + String gid
    + String originUrl
    + String fullShortUrl
    + String favicon
}

class ShortLinkPageReqDTO {
    + String gid
    + Integer current
    + Integer size
    + String orderTag
}

class ShortLinkPageRespDTO {
    + String domain
    + String shortUri
    + String fullShortUrl
    + String originUrl
    + Integer clickNum
    + String gid
    + String favicon
    + Integer enableStatus
    + Integer createdType
    + Integer validDateType
    + Date validDate
    + String describe
    + Integer totalPv
    + Integer totalUv
    + Integer totalUip
}

class ShortLinkStatsReqDTO {
    + String fullShortUrl
    + String gid
    + Date startDate
    + Date endDate
    + Boolean enableStatus
}

class ShortLinkStatsRespDTO {
    + Integer pv
    + Integer uv
    + Integer uip
    + List<ShortLinkStatsAccessDailyRespDTO> daily
    + List<ShortLinkStatsLocaleCNRespDTO> localeCnStats
    + List<ShortLinkStatsDeviceRespDTO> deviceStats
    + List<ShortLinkStatsBrowserRespDTO> browserStats
    + List<ShortLinkStatsOsRespDTO> osStats
}

UserRegisterReqDTO ..> UserLoginRespDTO
UserLoginReqDTO ..> UserLoginRespDTO
ShortLinkCreateReqDTO ..> ShortLinkCreateRespDTO
ShortLinkPageReqDTO ..> ShortLinkPageRespDTO
ShortLinkStatsReqDTO ..> ShortLinkStatsRespDTO
@enduml
```

### 2.3 时序图

#### 2.3.1 用户注册时序图

```plantuml
@startuml
title 用户注册时序图

actor 用户
participant 前端
participant 网关
participant 管理服务
participant 邮件服务
participant Redis
participant 数据库

用户 -> 前端: 填写注册信息
前端 -> 前端: 表单验证
用户 -> 前端: 点击发送验证码
前端 -> 网关: POST /api/short-link/admin/v1/user/send-code
网关 -> 管理服务: 转发请求
管理服务 -> Redis: 检查发送频率
activate Redis
Redis -> 管理服务: 返回检查结果
deactivate Redis
管理服务 -> 邮件服务: 发送验证码邮件
activate 邮件服务
邮件服务 -> 用户: 邮件验证码
deactivate 邮件服务
管理服务 -> Redis: 存储验证码(5分钟)
管理服务 -> 前端: 返回成功
前端 -> 用户: 显示发送成功

用户 -> 前端: 输入验证码并提交
前端 -> 网关: POST /api/short-link/admin/v1/user
网关 -> 管理服务: 转发注册请求
管理服务 -> Redis: 验证验证码
activate Redis
Redis -> 管理服务: 返回验证结果
deactivate Redis
alt 验证码正确
    管理服务 -> 数据库: 检查用户名是否存在
    activate 数据库
    数据库 -> 管理服务: 返回检查结果
    deactivate 数据库
    alt 用户名不存在
        管理服务 -> 管理服务: 加密密码
        管理服务 -> 数据库: 保存用户信息
        activate 数据库
        数据库 -> 管理服务: 返回保存结果
        deactivate 数据库
        管理服务 -> Redis: 删除验证码
        管理服务 -> 前端: 返回注册成功
        前端 -> 用户: 显示注册成功
    else 用户名已存在
        管理服务 -> 前端: 返回用户名已存在
        前端 -> 用户: 显示错误信息
    end
else 验证码错误
    管理服务 -> 前端: 返回验证码错误
    前端 -> 用户: 显示错误信息
end
@enduml
```

#### 2.3.2 短链接创建时序图

```plantuml
@startuml
title 短链接创建时序图

actor 用户
participant 前端
participant 网关
participant 管理服务
participant 项目服务
participant Redis
participant Kafka
participant 数据库

用户 -> 前端: 输入原始链接
前端 -> 前端: 链接格式验证
用户 -> 前端: 点击创建
前端 -> 网关: POST /api/short-link/admin/v1/create
网关 -> 网关: Token验证
网关 -> 管理服务: 转发请求
管理服务 -> 项目服务: 调用创建接口
activate 项目服务
项目服务 -> 项目服务: 生成短链接后缀(MurmurHash)
项目服务 -> Redis: 检查布隆过滤器
activate Redis
alt 布隆过滤器判断不存在
    Redis -> 项目服务: 返回false
    项目服务 -> 数据库: 检查唯一索引
    activate 数据库
    alt 唯一索引通过
        数据库 -> 项目服务: 返回成功
        项目服务 -> 数据库: 保存短链接信息
        数据库 -> 项目服务: 返回保存结果
        deactivate 数据库
        项目服务 -> Redis: 更新缓存
        项目服务 -> Redis: 更新布隆过滤器
        deactivate Redis
        项目服务 -> Kafka: 发送创建消息(可选)
        项目服务 -> 管理服务: 返回创建结果
        deactivate 项目服务
        管理服务 -> 前端: 返回短链接信息
        前端 -> 用户: 显示生成的短链接
    else 唯一索引冲突
        数据库 -> 项目服务: 抛出异常
        deactivate 数据库
        项目服务 -> 项目服务: 重新生成(最多10次)
        deactivate Redis
    end
else 布隆过滤器判断存在
    Redis -> 项目服务: 返回true
    项目服务 -> 数据库: 查询是否存在
    activate 数据库
    alt 数据库中不存在
        数据库 -> 项目服务: 返回不存在
        deactivate 数据库
        项目服务 -> 项目服务: 重新生成
        deactivate Redis
    else 数据库中已存在
        数据库 -> 项目服务: 返回已存在
        deactivate 数据库
        项目服务 -> 项目服务: 重新生成
        deactivate Redis
    end
end
@enduml
```

#### 2.3.3 短链接跳转时序图

```plantuml
@startuml
title 短链接跳转时序图

actor 访客
participant 浏览器
participant 网关
participant 项目服务
participant Redis
participant 数据库
participant Kafka

访客 -> 浏览器: 访问短链接
浏览器 -> 网关: GET /api/short-link/v1/{short-uri}
网关 -> 项目服务: 转发请求
activate 项目服务
项目服务 -> Redis: 查询缓存
activate Redis
alt 缓存命中
    Redis -> 项目服务: 返回原始链接
    deactivate Redis
    项目服务 -> 项目服务: 记录访问日志
    项目服务 -> Kafka: 发送统计消息
    activate Kafka
    Kafka -> Kafka: 异步处理
    deactivate Kafka
    项目服务 -> 浏览器: 返回302重定向
    浏览器 -> 访客: 跳转到原始链接
    deactivate 项目服务
else 缓存未命中
    deactivate Redis
    项目服务 -> Redis: 检查缓存穿透标记
    activate Redis
    alt 存在穿透标记
        Redis -> 项目服务: 返回标记
        deactivate Redis
        项目服务 -> 浏览器: 返回404
        浏览器 -> 访客: 显示404页面
        deactivate 项目服务
    else 不存在穿透标记
        deactivate Redis
        项目服务 -> 项目服务: 获取分布式锁
        activate Redis
        项目服务 -> Redis: 获取锁
        Redis -> 项目服务: 返回锁
        deactivate Redis
        项目服务 -> Redis: 双重检查缓存
        activate Redis
        alt 缓存已存在
            Redis -> 项目服务: 返回原始链接
            deactivate Redis
            项目服务 -> Redis: 释放锁
            项目服务 -> 浏览器: 返回302重定向
        else 缓存不存在
            deactivate Redis
            项目服务 -> 数据库: 查询短链接信息
            activate 数据库
            alt 数据库中存在
                数据库 -> 项目服务: 返回链接信息
                项目服务 -> 项目服务: 验证有效期和状态
                alt 链接有效
                    项目服务 -> Redis: 更新缓存
                    项目服务 -> 项目服务: 记录访问日志
                    项目服务 -> Kafka: 发送统计消息
                    项目服务 -> 数据库: 更新点击量
                    数据库 -> 项目服务: 返回更新结果
                    deactivate 数据库
                    项目服务 -> Redis: 释放锁
                    项目服务 -> 浏览器: 返回302重定向
                    浏览器 -> 访客: 跳转到原始链接
                else 链接无效
                    项目服务 -> Redis: 设置穿透标记
                    项目服务 -> Redis: 释放锁
                    项目服务 -> 浏览器: 返回404
                    deactivate 数据库
                end
            else 数据库中不存在
                数据库 -> 项目服务: 返回不存在
                deactivate 数据库
                项目服务 -> Redis: 设置穿透标记
                项目服务 -> Redis: 释放锁
                项目服务 -> 浏览器: 返回404
            end
        end
        deactivate 项目服务
    end
end
@enduml
```

#### 2.3.4 统计数据收集时序图

```plantuml
@startuml
title 统计数据收集时序图

participant 项目服务
participant Kafka
participant 统计消费者
participant 高德地图API
participant Redis
participant 数据库

项目服务 -> 项目服务: 记录访问日志
项目服务 -> Kafka: 发送统计消息
activate Kafka
Kafka -> 统计消费者: 消费消息
activate 统计消费者
统计消费者 -> 统计消费者: 解析访问信息
统计消费者 -> 高德地图API: 获取地理位置信息
activate 高德地图API
高德地图API -> 统计消费者: 返回位置信息
deactivate 高德地图API
统计消费者 -> 统计消费者: 解析User-Agent
统计消费者 -> 统计消费者: 识别设备类型
统计消费者 -> 统计消费者: 识别浏览器类型
统计消费者 -> 统计消费者: 识别操作系统
统计消费者 -> 统计消费者: 识别网络类型

统计消费者 -> 数据库: 更新访问统计表
activate 数据库
数据库 -> 统计消费者: 返回更新结果
deactivate 数据库
统计消费者 -> 数据库: 更新浏览器统计表
统计消费者 -> 数据库: 更新设备统计表
统计消费者 -> 数据库: 更新地区统计表
统计消费者 -> 数据库: 更新网络统计表
统计消费者 -> 数据库: 更新操作系统统计表
统计消费者 -> 数据库: 更新今日统计表
统计消费者 -> Redis: 更新实时统计缓存
activate Redis
Redis -> 统计消费者: 返回更新结果
deactivate Redis
统计消费者 -> Kafka: 提交offset
deactivate 统计消费者
Kafka -> Kafka: 确认消息处理完成
deactivate Kafka
@enduml
```

### 2.4 活动图

#### 2.4.1 用户注册活动图

```plantuml
@startuml
title 用户注册活动图

start
:用户打开注册页面;
:填写注册信息\n(用户名、密码、真实姓名、\n手机号、邮箱);
:点击发送验证码;
:前端验证邮箱格式;
if (邮箱格式正确?) then (是)
    :发送验证码请求;
    :检查发送频率;
    if (频率限制?) then (是)
        :返回错误提示;
        stop
    else (否)
        :生成验证码;
        :发送邮件;
        :存储验证码到Redis\n(5分钟过期);
        :显示发送成功;
    endif
else (否)
    :显示邮箱格式错误;
    stop
endif
:用户输入验证码;
:用户提交注册信息;
:前端验证表单;
if (表单验证通过?) then (是)
    :发送注册请求;
    :验证验证码;
    if (验证码正确?) then (是)
        :检查用户名是否存在;
        if (用户名已存在?) then (是)
            :返回用户名已存在错误;
            stop
        else (否)
            :加密密码;
            :加密手机号和邮箱;
            :保存用户信息到数据库;
            :删除验证码;
            :返回注册成功;
            stop
        endif
    else (否)
        :返回验证码错误;
        stop
    endif
else (否)
    :显示表单验证错误;
    stop
endif
@enduml
```

#### 2.4.2 短链接创建活动图

```plantuml
@startuml
title 短链接创建活动图

start
:用户输入原始链接;
:前端验证链接格式;
if (链接格式正确?) then (是)
    :用户选择分组;
    :用户设置有效期(可选);
    :用户输入描述(可选);
    :用户点击创建;
    :发送创建请求;
    :Token验证;
    if (Token有效?) then (是)
        :验证原始链接白名单;
        if (在白名单中?) then (是)
            :生成短链接后缀\n(MurmurHash算法);
            :检查布隆过滤器;
            if (布隆过滤器判断存在?) then (是)
                :查询数据库验证;
                if (数据库中已存在?) then (是)
                    :重新生成短链接\n(最多10次);
                else (否)
                    :继续创建流程;
                endif
            else (否)
                :继续创建流程;
            endif
            :插入数据库;
            if (唯一索引冲突?) then (是)
                :捕获异常;
                :重新生成短链接\n(最多10次);
            else (否)
                :更新Redis缓存;
                :更新布隆过滤器;
                :发送Kafka消息(可选);
                :返回创建成功;
                stop
            endif
        else (否)
            :返回白名单错误;
            stop
        endif
    else (否)
        :返回未授权错误;
        stop
    endif
else (否)
    :显示链接格式错误;
    stop
endif
@enduml
```

#### 2.4.3 短链接跳转活动图

```plantuml
@startuml
title 短链接跳转活动图

start
:访客访问短链接;
:网关接收请求;
:路由到项目服务;
:查询Redis缓存;
if (缓存命中?) then (是)
    :验证链接有效性;
    if (链接有效?) then (是)
        :记录访问日志;
        :发送Kafka统计消息;
        :返回302重定向;
        stop
    else (否)
        :返回404错误;
        stop
    endif
else (否)
    :检查缓存穿透标记;
    if (存在穿透标记?) then (是)
        :返回404错误;
        stop
    else (否)
        :获取分布式锁;
        :双重检查缓存;
        if (缓存已存在?) then (是)
            :释放锁;
            :返回302重定向;
            stop
        else (否)
            :查询数据库;
            if (数据库中存在?) then (是)
                :验证有效期;
                if (链接有效?) then (是)
                    :验证启用状态;
                    if (链接已启用?) then (是)
                        :更新Redis缓存;
                        :记录访问日志;
                        :发送Kafka统计消息;
                        :更新点击量;
                        :释放锁;
                        :返回302重定向;
                        stop
                    else (否)
                        :设置穿透标记;
                        :释放锁;
                        :返回404错误;
                        stop
                    endif
                else (否)
                    :设置穿透标记;
                    :释放锁;
                    :返回404错误;
                    stop
                endif
            else (否)
                :设置穿透标记;
                :释放锁;
                :返回404错误;
                stop
            endif
        endif
    endif
endif
@enduml
```

### 2.5 状态图

#### 2.5.1 短链接状态图

```plantuml
@startuml
title 短链接状态图

[*] --> 已创建 : 创建短链接

已创建 --> 已启用 : 启用链接
已创建 --> 已删除 : 删除链接

已启用 --> 已禁用 : 禁用链接
已启用 --> 已过期 : 有效期到期
已启用 --> 已删除 : 删除链接

已禁用 --> 已启用 : 启用链接
已禁用 --> 已删除 : 删除链接

已过期 --> 已删除 : 删除链接

已删除 --> 已恢复 : 恢复链接
已删除 --> [*] : 彻底删除

已恢复 --> 已启用 : 启用链接
已恢复 --> 已禁用 : 禁用链接

note right of 已创建
  短链接创建后的初始状态
end note

note right of 已启用
  链接可以正常访问
end note

note right of 已禁用
  链接无法访问
end note

note right of 已过期
  链接超过有效期
end note

note right of 已删除
  链接被移至回收站
end note

note right of 已恢复
  链接从回收站恢复
end note
@enduml
```

#### 2.5.2 用户账户状态图

```plantuml
@startuml
title 用户账户状态图

[*] --> 未注册 : 初始化

未注册 --> 已注册 : 用户注册

已注册 --> 已登录 : 用户登录
已注册 --> 已注销 : 账户注销

已登录 --> 已登出 : 退出登录
已登录 --> 已注销 : 账户注销
已登录 --> 已冻结 : 账户冻结

已登出 --> 已登录 : 重新登录

已冻结 --> 已登录 : 账户解冻
已冻结 --> 已注销 : 账户注销

已注销 --> [*] : 彻底删除

note right of 未注册
  用户未注册状态
end note

note right of 已注册
  用户已注册但未登录
end note

note right of 已登录
  用户已登录系统
end note

note right of 已登出
  用户已退出登录
end note

note right of 已冻结
  账户因违规被冻结
end note

note right of 已注销
  用户主动注销账户
end note
@enduml
```

### 2.6 组件图

#### 2.6.1 系统组件图

```plantuml
@startuml
title 短链接系统组件图

package "前端组件" {
    [React前端应用]
    [用户界面组件]
    [管理界面组件]
    [图表组件]
}

package "网关组件" {
    [Gateway服务]
    [路由组件]
    [认证组件]
    [限流组件]
}

package "管理服务组件" {
    [用户管理组件]
    [分组管理组件]
    [短链接管理组件]
    [回收站组件]
    [邮件服务组件]
}

package "项目服务组件" {
    [短链接生成组件]
    [短链接跳转组件]
    [统计分析组件]
    [访问日志组件]
    [Kafka生产者组件]
    [Kafka消费者组件]
}

package "数据访问组件" {
    [UserMapper]
    [GroupMapper]
    [LinkMapper]
    [LinkGoToMapper]
    [LinkAccessLogsMapper]
    [LinkAccessStatsMapper]
}

package "中间件组件" {
    [Nacos客户端]
    [Redis客户端]
    [Kafka客户端]
    [MySQL连接池]
    [MinIO客户端]
}

package "工具组件" {
    [HashUtil]
    [LinkUtil]
    [DateUtil]
    [EncryptUtil]
}

[React前端应用] --> [Gateway服务]
[Gateway服务] --> [用户管理组件]
[Gateway服务] --> [短链接生成组件]
[用户管理组件] --> [UserMapper]
[分组管理组件] --> [GroupMapper]
[短链接生成组件] --> [LinkMapper]
[短链接跳转组件] --> [LinkGoToMapper]
[统计分析组件] --> [LinkAccessStatsMapper]
[访问日志组件] --> [LinkAccessLogsMapper]
[Kafka生产者组件] --> [Kafka客户端]
[Kafka消费者组件] --> [Kafka客户端]
[用户管理组件] --> [Redis客户端]
[短链接生成组件] --> [Redis客户端]
[用户管理组件] --> [邮件服务组件]
[短链接生成组件] --> [HashUtil]
[短链接生成组件] --> [LinkUtil]
@enduml
```

### 2.7 部署图

#### 2.7.1 系统部署图

```plantuml
@startuml
title 短链接系统部署图

node "负载均衡器" {
    [Nginx]
}

node "Web服务器集群" {
    [Web Server 1]
    [Web Server 2]
    [Web Server N]
}

node "网关服务集群" {
    [Gateway 1] : 8000
    [Gateway 2] : 8000
    [Gateway N] : 8000
}

node "管理服务集群" {
    [Admin Service 1] : 8002
    [Admin Service 2] : 8002
    [Admin Service N] : 8002
}

node "项目服务集群" {
    [Project Service 1] : 8001
    [Project Service 2] : 8001
    [Project Service N] : 8001
}

node "注册中心" {
    [Nacos] : 8848
}

node "缓存集群" {
    [Redis Master 1]
    [Redis Slave 1]
    [Redis Master 2]
    [Redis Slave 2]
}

node "消息队列集群" {
    [Kafka Broker 1] : 9092
    [Kafka Broker 2] : 9092
    [Kafka Broker 3] : 9092
    [Zookeeper] : 2181
}

node "数据库集群" {
    [MySQL Master] : 3306
    [MySQL Slave 1] : 3306
    [MySQL Slave 2] : 3306
}

node "对象存储" {
    [MinIO] : 9000/9001
}

node "CDN" {
    [CDN节点]
}

[Web Server 1] --> [Gateway 1]
[Web Server 2] --> [Gateway 2]
[Gateway 1] --> [Nacos]
[Gateway 2] --> [Nacos]
[Admin Service 1] --> [Nacos]
[Admin Service 2] --> [Nacos]
[Project Service 1] --> [Nacos]
[Project Service 2] --> [Nacos]
[Admin Service 1] --> [Redis Master 1]
[Project Service 1] --> [Redis Master 1]
[Project Service 1] --> [Kafka Broker 1]
[Admin Service 1] --> [MySQL Master]
[Project Service 1] --> [MySQL Master]
[Admin Service 1] --> [MinIO]
[CDN节点] --> [Nginx]
@enduml
```

#### 2.7.2 容器化部署图

```plantuml
@startuml
title 容器化部署图

node "Docker宿主机1" {
    container "Gateway容器" {
        [Gateway Service]
    }
    container "Admin容器" {
        [Admin Service]
    }
    container "Project容器" {
        [Project Service]
    }
}

node "Docker宿主机2" {
    container "Gateway容器" {
        [Gateway Service]
    }
    container "Admin容器" {
        [Admin Service]
    }
    container "Project容器" {
        [Project Service]
    }
}

node "中间件集群" {
    container "MySQL容器" {
        [MySQL 8.0]
    }
    container "Redis容器" {
        [Redis 7]
    }
    container "Kafka容器" {
        [Kafka 7.4.0]
    }
    container "Zookeeper容器" {
        [Zookeeper]
    }
    container "Nacos容器" {
        [Nacos 2.4.2]
    }
    container "MinIO容器" {
        [MinIO]
    }
}

[Gateway Service] --> [Nacos]
[Admin Service] --> [Nacos]
[Project Service] --> [Nacos]
[Admin Service] --> [MySQL 8.0]
[Project Service] --> [MySQL 8.0]
[Admin Service] --> [Redis 7]
[Project Service] --> [Redis 7]
[Project Service] --> [Kafka 7.4.0]
[Kafka 7.4.0] --> [Zookeeper]
[Admin Service] --> [MinIO]
@enduml
```

### 2.8 包图

#### 2.8.1 管理服务包图

```plantuml
@startuml
title 管理服务包图

package "com.xduo.shortlink.admin" {
    package "controller" {
        [UserController]
        [GroupController]
        [ShortLinkController]
        [RecycleBinController]
        [ShortLinkStatsController]
    }
    
    package "service" {
        package "impl" {
            [UserServiceImpl]
            [GroupServiceImpl]
            [RecycleBinServiceImpl]
            [EmailServiceImpl]
        }
        [UserService]
        [GroupService]
        [RecycleBinService]
        [EmailService]
    }
    
    package "dao" {
        package "entity" {
            [UserDO]
            [GroupDO]
        }
        package "mapper" {
            [UserMapper]
            [GroupMapper]
        }
    }
    
    package "dto" {
        package "req" {
            [UserRegisterReqDTO]
            [UserLoginReqDTO]
            [GroupSaveReqDTO]
        }
        package "resp" {
            [UserRespDTO]
            [UserLoginRespDTO]
            [GroupRespDTO]
        }
    }
    
    package "common" {
        package "convention" {
            [Result]
            [Results]
            [BaseErrorCode]
        }
        package "biz" {
            package "user" {
                [UserContext]
                [UserInfoDTO]
            }
        }
    }
    
    package "remote" {
        [ShortLinkActualRemoteService]
    }
    
    package "config" {
        [DataBaseConfiguration]
        [MinIOConfig]
        [UserConfiguration]
    }
}

[UserController] --> [UserService]
[GroupController] --> [GroupService]
[UserService] --> [UserServiceImpl]
[GroupService] --> [GroupServiceImpl]
[UserServiceImpl] --> [UserMapper]
[GroupServiceImpl] --> [GroupMapper]
[UserMapper] --> [UserDO]
[GroupMapper] --> [GroupDO]
[UserController] --> [UserRegisterReqDTO]
[UserController] --> [UserRespDTO]
[ShortLinkController] --> [ShortLinkActualRemoteService]
@enduml
```

#### 2.8.2 项目服务包图

```plantuml
@startuml
title 项目服务包图

package "com.xduo.shortlink.project" {
    package "controller" {
        [ShortLinkController]
        [ShortLinkGoToController]
        [ShortLinkStatsController]
        [RecycleBinController]
        [UrlTitleController]
    }
    
    package "service" {
        package "impl" {
            [LinkServiceImpl]
            [LinkGoToServiceImpl]
            [ShortLinkStatsServiceImpl]
            [LinkAccessLogsServiceImpl]
        }
        [LinkService]
        [LinkGoToService]
        [ShortLinkStatsService]
        [LinkAccessLogsService]
    }
    
    package "dao" {
        package "entity" {
            [LinkDO]
            [LinkGoToDO]
            [LinkAccessLogsDO]
            [LinkAccessStatsDO]
            [LinkBrowserStatsDO]
            [LinkDeviceStatsDO]
            [LinkLocaleStatsDO]
            [LinkNetworkStatsDO]
            [LinkOsStatsDO]
        }
        package "mapper" {
            [LinkMapper]
            [LinkGoToMapper]
            [LinkAccessLogsMapper]
            [LinkAccessStatsMapper]
        }
    }
    
    package "dto" {
        package "req" {
            [ShortLinkCreateReqDTO]
            [ShortLinkPageReqDTO]
            [ShortLinkUpdateReqDTO]
            [ShortLinkStatsReqDTO]
        }
        package "resp" {
            [ShortLinkCreateRespDTO]
            [ShortLinkPageRespDTO]
            [ShortLinkStatsRespDTO]
        }
    }
    
    package "mq" {
        package "producer" {
            [ShortLinkStatsKafkaProducer]
        }
        package "consumer" {
            [ShortLinkStatsKafkaConsumer]
        }
    }
    
    package "util" {
        [HashUtil]
        [LinkUtil]
    }
    
    package "config" {
        [DateBaseConfiguration]
        [KafkaConfig]
        [RBloomFilterConfiguration]
        [SentinelRuleConfig]
    }
    
    package "common" {
        package "convention" {
            [Result]
            [Results]
            [BaseErrorCode]
        }
    }
}

[ShortLinkController] --> [LinkService]
[ShortLinkGoToController] --> [LinkGoToService]
[ShortLinkStatsController] --> [ShortLinkStatsService]
[LinkService] --> [LinkServiceImpl]
[LinkServiceImpl] --> [LinkMapper]
[LinkServiceImpl] --> [HashUtil]
[LinkServiceImpl] --> [ShortLinkStatsKafkaProducer]
[LinkMapper] --> [LinkDO]
[ShortLinkStatsKafkaConsumer] --> [LinkAccessLogsMapper]
[ShortLinkStatsKafkaConsumer] --> [LinkAccessStatsMapper]
@enduml
```

#### 2.8.3 网关服务包图

```plantuml
@startuml
title 网关服务包图

package "com.xduo.shortlink.gateway" {
    package "filter" {
        [TokenValidateGatewayFilterFactory]
    }
    
    package "config" {
        [CorsConfig]
        [Config]
    }
    
    package "dto" {
        [GatewayErrorResult]
    }
    
    [GatewayServiceApplication]
}

[GatewayServiceApplication] --> [TokenValidateGatewayFilterFactory]
[TokenValidateGatewayFilterFactory] --> [CorsConfig]
[TokenValidateGatewayFilterFactory] --> [GatewayErrorResult]
@enduml
```

---

## 总结

本文档详细描述了短链接系统的建模与设计，包括：

1. **系统目标与框架**：明确了系统的业务目标、技术目标和架构框架
2. **UML建模**：提供了完整的UML建模图，包括：
   - **用例图**：描述了系统的功能需求和用户交互
   - **类图**：展示了系统的静态结构和类之间的关系
   - **时序图**：描述了系统动态交互过程
   - **活动图**：展示了业务流程和活动流程
   - **状态图**：描述了对象的状态转换
   - **组件图**：展示了系统的组件结构和依赖关系
   - **部署图**：展示了系统的部署架构和硬件配置
   - **包图**：展示了系统的包结构和模块划分

这些UML图从不同角度全面描述了系统的设计和实现，为系统的开发、维护和扩展提供了重要的参考依据。
